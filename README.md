# hallyy
HALLYY Agricultural drone soil sampling project 

## Solution Breakdown
Our proposed solution allows for a highly automated method of collecting soil samples from farms, with an emphasis on ease of user control. This solution combines a front end UI with a drone autopilot and planning system. This allows a drone, equipped with a custom designed sampling device, to survey a field and collect samples at a specified precision without needing the overhead cost of a human operator.

### Frontend Webapp

Weâ€™ve built an end-to-end drone software system, from a custom consumer-facing web-app to a drone autopilot and mission control software in the backend. 

Currently, our frontend allows a user to pan and zoom into their farmland from satellite view. With our intuitive UI, they can easily select the area of soil they want sampled by drawing a polygon shape. Our web app automatically populates the selected area with a grid of markers that can then be dragged around individually, each representing a sampling coordinate. 

### Backend Mission Planning

Once the user is satisfied, all they need to do is click Start Soil Sampling, and the coordinates are sent to our backend Python server. An optimal flight path is then determined to allow the drone to sample all the desired points in the shortest time. The backendw then converts this flight path into a format compatable with the ardupilot drone control suite. As an approprate drone would be prohibitively expensive at this stage, with models over $30,000, the backend is currently set up to test the proposed mission plan in Gazebo, a simulation software.

Ultimately, the intention is for the server to relay these commands to the corresponding drone platform that is sent to the user, as well as collect telemetry data based on drone performance. It will also store the results of the soil sampling from laboratory testing, and provide this information to the front end to produce an easy to understand map of soil characteristics for the end user.

### Physical Drone Platform and Sampler

The drone platform consists of an existing heavy lift drone, with the sampling apparatus attached. The sampling apparatus consists of a rotating carousel of sampling probes - steel tubes measuring 30cm x 2cm - and a retreival vehicle into which these probes can be inserted or extracted from. This vehicle can then be lowered down by a motorized winch to the ground, at which time it would anchor itself using deployable legs and drive the probe into the soil to collect a sample. After collection, it would be retreived by the winch, the old probe containing the sample will be extracted, and a new probe will be inserted, readying the device for the next sampling location. The drone would move along the planned path, stopping at the desired locations to perform the above procedure.

## Technologies

### Frontend Technologies
Our web-app frontend is built using React, TypeScript, CSS, and Webpack. The frontend features an open source mapping library called Mapbox GL. 

The frontend source code is split into 5 main TypeScript files: 

- app.tsx
- control-panel.tsx
- draw-control.ts
- pin.tsx
- polygon-utils.ts

App.tsx contains the main app, including the navigation header, buttons, and map components. It handles click, panning, zoom, drag, and drawing events in custom functions. This file also contains the code for determining when a polygon has been drawn, for generating marker locations inside the polygon when the "Generate Locations" button is clicked, and for sending those locations to our backend server upon clicking the "Start Sampling Soil" button.

Control-panel.tsx contains the React component for displaying the Mission Control UI panel. It currently shows information about how much area is selected within a polygon, although we plan to add more in-depth functionality and data, such as coordinates of all autogenerated marker locations.

Draw-control.ts contains the TypeScript code for handling and updating the drawing of the polygon, by using MapboxDraw from @mapbox/mapbox-gl-draw.

Pin.tsx contains the React component for displaying pin markers on the map.

Polygon-utils.ts contains the TypeScript algorithms for calculating the center point of any drawn polygon, thereby giving the location coordinates to send to the backend. This is where we plan on writing a more complex algorithm for determining how to disseminate the points in any drawn area in an even distribution across the polygon. 

### Frontend Instructions

Clone the repository. Navigate into the hallyy-frontend directory, and run the following command to install all dependencies:

```
npm i
```

Then, run the React app on local development using the following command:

```
npm run start
```

Now, you should be able to access the app in your browser at the url `localhost:8080`.

### Backend Technologies
Our backend is currently written in Python, and uses several open-source libraries, including Pymavlink, Gazebo, and PX4. These are open-source libraries for mission planning and communicating with industry-standard drones. 

Our backend is currently split into two files: 

- offboard_position_ned.py
- mission.py

offboard_position_ned.py contains the code for simulating flying drone in a square given 4 coordinate locations, stopping at each corner to drop to the ground and sample the soil.

mission.py is still in prototype mode, although we are writing the code for automating a pymavlink mission based on gps co-ordinates sent via API calls from the frontend.

### Backend Instructions
To run our drone simulation, download px4 codebase and gazebo drone simulator and run the px4 software in the loop build.
Then, navigate into hallyy-backend to execute the backend pymavlink scripts.

The download links can be found here:

- Pymavlink: https://github.com/ArduPilot/pymavlink/
- Gazebo simulator: https://docs.px4.io/main/en/simulation/gazebo.html
- PX4 Software in the Loop: https://docs.px4.io/main/en/simulation/

To use QGroundControl, directly download app from internet and follow the instructions on their documentation: https://docs.qgroundcontrol.com/master/en/
